name: Auto-merge Bot PRs

on:
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["Mimir CI/CD"]
    types: [completed]
  schedule:
    # Check every 15 minutes for PRs ready to merge
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      checks: read
      actions: read
    
    steps:
      - name: Check PR details
        id: pr_check
        uses: actions/github-script@v7
        with:
          script: |
            // Handle scheduled runs - find bot PRs ready to merge
            if (context.eventName === 'schedule') {
              const { data: pulls } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 50
              });
              
              console.log(`Scheduled check: Found ${pulls.length} open PRs`);
              
              // Find bot PRs
              const botPRs = pulls.filter(pr => 
                pr.user.login.includes('copilot') || pr.user.type === 'Bot'
              );
              
              console.log(`Found ${botPRs.length} bot PRs to check`);
              
              // Check each bot PR
              for (const pr of botPRs) {
                await processPR(pr.number);
              }
              
              return;
            }
            
            // Handle event-driven runs
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.check_suite?.pull_requests?.[0]?.number ||
                           context.payload.workflow_run?.pull_requests?.[0]?.number;
            
            if (!prNumber) {
              console.log('No PR number found, skipping');
              return;
            }
            
            await processPR(prNumber);
            
            async function processPR(prNum) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNum
              });
            
              console.log(`PR #${pr.number}: ${pr.title}`);
              console.log(`Author: ${pr.user.login}`);
              console.log(`State: ${pr.state}`);
              
              // Skip if not a bot PR
              if (!pr.user.login.includes('copilot') && pr.user.type !== 'Bot') {
                console.log('Not a bot PR, skipping');
                return;
              }
              
              // Get check runs for this PR
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
                per_page: 100
              });
              
              console.log(`Total check runs: ${checkRuns.check_runs.length}`);
              
              // If no checks, DO NOT merge - require at least one passing check
              if (checkRuns.check_runs.length === 0) {
                console.log('‚ö†Ô∏è  No checks found - BLOCKING merge until CI runs');
                core.setOutput('pr_number', pr.number);
                core.setOutput('all_passed', 'false');
                core.setOutput('has_failures', 'false');
                core.setOutput('is_pending', 'true');
                core.setOutput('no_checks', 'true');
                
                // Comment on PR requiring checks
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: '‚ö†Ô∏è **No CI checks detected**\n\nThis PR cannot be auto-merged until CI workflows run and pass.\n\nPlease ensure:\n1. CI workflows are triggered\n2. All tests pass\n3. All checks complete successfully\n\n**Auto-merge is blocked until checks pass.**'
                });
                return;
              }
              
              const failedChecks = checkRuns.check_runs.filter(check => 
                check.conclusion === 'failure' || check.conclusion === 'cancelled' || check.conclusion === 'timed_out'
              );
              
              const pendingChecks = checkRuns.check_runs.filter(check => 
                check.status !== 'completed'
              );
              
              const successChecks = checkRuns.check_runs.filter(check =>
                check.conclusion === 'success'
              );
              
              console.log(`Failed checks: ${failedChecks.length}`);
              console.log(`Pending checks: ${pendingChecks.length}`);
              console.log(`Success checks: ${successChecks.length}`);
              
              // STRICT: Require ALL checks to pass, ZERO failures
              const allPassed = failedChecks.length === 0 && 
                               pendingChecks.length === 0 && 
                               successChecks.length > 0;
              
              console.log(`All passed: ${allPassed}`);
              
              // Return status
              core.setOutput('pr_number', pr.number);
              core.setOutput('all_passed', allPassed);
              core.setOutput('has_failures', failedChecks.length > 0);
              core.setOutput('is_pending', pendingChecks.length > 0);
              core.setOutput('no_checks', 'false');
              
              if (failedChecks.length > 0) {
                const failedNames = failedChecks.map(c => c.name).join(', ');
                core.setOutput('failed_checks', failedNames);
              }
            }
      
      - name: Auto-approve PR
        if: steps.pr_check.outputs.pr_number != '' && steps.pr_check.outputs.is_pending == 'false' && steps.pr_check.outputs.all_passed == 'true' && steps.pr_check.outputs.no_checks == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_check.outputs.pr_number }},
              event: 'APPROVE',
              body: '‚úÖ **All checks passed!** Auto-approving bot PR.\n\n‚úÖ All tests passed\n‚úÖ All checks successful\n‚úÖ Ready to merge'
            });
      
      - name: Merge PR
        if: steps.pr_check.outputs.pr_number != '' && steps.pr_check.outputs.all_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const prNumber = ${{ steps.pr_check.outputs.pr_number }};
              
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Auto-merge: Bot PR #${prNumber}`,
                commit_message: 'Automated merge of bot PR after all checks passed (or no checks required).'
              });
              
              console.log(`‚úÖ PR #${prNumber} merged successfully!`);
              
              // Post success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'üéâ **Auto-merged!** This PR has been automatically merged into master.\n\nü§ñ Automated by continuous improvement system'
              });
            } catch (error) {
              console.error('Failed to merge:', error.message);
              
              // Post error comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr_check.outputs.pr_number }},
                body: `‚ö†Ô∏è **Auto-merge failed:** ${error.message}\n\nManual merge may be required.`
              });
            }
      
      - name: Request fixes for failed checks
        if: steps.pr_check.outputs.pr_number != '' && steps.pr_check.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failedChecks = '${{ steps.pr_check.outputs.failed_checks }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              body: `‚ùå **TESTS FAILED - MERGE BLOCKED**\n\nThe following checks failed:\n- ${failedChecks.split(', ').join('\n- ')}\n\n**This PR CANNOT be merged until ALL tests pass.**\n\n@app/copilot-swe-agent Please:\n1. Review the test failures\n2. Fix the issues in the code\n3. Push updates to this PR\n4. Ensure ALL tests pass\n\n**ZERO failures required for merge.**`
            });
            
            // Request changes to block merge
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_check.outputs.pr_number }},
              event: 'REQUEST_CHANGES',
              body: '‚ùå Tests failed. Cannot merge until all checks pass.'
            });
            
            console.log('Posted comment requesting fixes and blocked merge');
