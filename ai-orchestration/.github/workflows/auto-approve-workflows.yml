name: Auto-approve and Run Workflows

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["*"]
    types: [requested]
  schedule:
    # Auto-approve pending runs every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  auto-approve-workflows:
    runs-on: ubuntu-latest
    
    permissions:
      actions: write
      contents: read
      pull-requests: write
    
    steps:
      - name: Auto-approve ALL pending workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('üîç Searching for ALL workflow runs requiring approval...');
            
            // Get ALL pending workflow runs (all events, all branches)
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'action_required',
              per_page: 100
            });
            
            console.log(`Found ${runs.workflow_runs.length} workflow runs needing approval`);
            
            if (runs.workflow_runs.length === 0) {
              console.log('‚úÖ No pending approvals found');
              return;
            }
            
            // Approve ALL pending runs automatically
            let approved = 0;
            let failed = 0;
            
            for (const run of runs.workflow_runs) {
              try {
                console.log(`Approving run ${run.id}: ${run.name} (${run.event}) on ${run.head_branch}`);
                
                await github.rest.actions.approveWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                
                approved++;
                console.log(`‚úÖ Approved run ${run.id}`);
              } catch (error) {
                failed++;
                console.error(`‚ùå Failed to approve run ${run.id}:`, error.message);
              }
            }
            
            console.log(`\nüìä Summary: ${approved} approved, ${failed} failed out of ${runs.workflow_runs.length} total`);
            core.setOutput('approved_count', approved);
            core.setOutput('failed_count', failed);
      
      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'pull_request_target' && github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '‚úÖ **Workflows Auto-Approved**\n\nAll required workflows have been approved and will run automatically.\n\nü§ñ Automated by bot PR approval system'
            });
