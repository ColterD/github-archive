name: Branch Cleanup

on:
  pull_request:
    types: [closed]
  # Also run weekly to clean up any stale branches
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday
  workflow_dispatch:

# Restrict default permissions - jobs declare what they need
permissions: {}

jobs:
  # Delete merged PR branches automatically
  delete-merged-branch:
    name: Delete Merged Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    permissions:
      contents: write

    steps:
      - name: Delete branch
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Don't delete protected branches
            const protectedBranches = ['main', 'master', 'develop', 'staging', 'production'];
            if (protectedBranches.includes(branch)) {
              console.log(`Skipping protected branch: ${branch}`);
              return;
            }

            // Don't delete branches from forks
            if (context.payload.pull_request.head.repo.full_name !== context.payload.pull_request.base.repo.full_name) {
              console.log(`Skipping fork branch: ${branch}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${branch}`
              });
              console.log(`Deleted branch: ${branch}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`Branch already deleted: ${branch}`);
              } else {
                throw error;
              }
            }

  # Cleanup stale branches (not merged but old)
  cleanup-stale-branches:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Find and report stale branches
        run: |
          echo "## Stale Branches Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branches with no commits in the last 90 days:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find branches older than 90 days
          STALE_DATE=$(date -d '90 days ago' +%Y-%m-%d 2>/dev/null || date -v-90d +%Y-%m-%d)

          git for-each-ref --sort=-committerdate refs/remotes/origin --format='%(refname:short) %(committerdate:short)' | \
          grep -v 'origin/HEAD' | \
          grep -v 'origin/main' | \
          grep -v 'origin/master' | \
          while read branch date; do
            if [[ "$date" < "$STALE_DATE" ]]; then
              echo "- \`${branch#origin/}\` (last commit: $date)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: This is a report only. Manual review required before deletion.*" >> $GITHUB_STEP_SUMMARY
