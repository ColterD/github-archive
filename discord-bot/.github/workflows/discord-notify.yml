name: Discord Notifications

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["CI", "Security Scanning"]
    types: [completed]

permissions:
  contents: read

jobs:
  # Notify on new releases
  release-notification:
    name: Release Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Send release notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_TYPE: ${{ github.event.release.prerelease && 'Pre-release' || 'Stable' }}
          RELEASE_AUTHOR: ${{ github.event.release.author.login }}
          RELEASE_TIME: ${{ github.event.release.published_at }}
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"New Release: $RELEASE_TAG\",
                \"description\": \"$RELEASE_NAME\",
                \"url\": \"$RELEASE_URL\",
                \"color\": 5763719,
                \"fields\": [
                  {
                    \"name\": \"Release Type\",
                    \"value\": \"$RELEASE_TYPE\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Author\",
                    \"value\": \"$RELEASE_AUTHOR\",
                    \"inline\": true
                  }
                ],
                \"footer\": {
                  \"text\": \"discord-bot\"
                },
                \"timestamp\": \"$RELEASE_TIME\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

  # Notify on workflow failures
  failure-notification:
    name: Failure Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'

    steps:
      - name: Send failure notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          WORKFLOW_SHA: ${{ github.event.workflow_run.head_sha }}
          WORKFLOW_ACTOR: ${{ github.event.workflow_run.actor.login }}
          WORKFLOW_TIME: ${{ github.event.workflow_run.updated_at }}
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"Workflow Failed: $WORKFLOW_NAME\",
                \"description\": \"The workflow failed on branch \`$WORKFLOW_BRANCH\`\",
                \"url\": \"$WORKFLOW_URL\",
                \"color\": 15548997,
                \"fields\": [
                  {
                    \"name\": \"Commit\",
                    \"value\": \"\`$WORKFLOW_SHA\`\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Triggered By\",
                    \"value\": \"$WORKFLOW_ACTOR\",
                    \"inline\": true
                  }
                ],
                \"footer\": {
                  \"text\": \"discord-bot CI\"
                },
                \"timestamp\": \"$WORKFLOW_TIME\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
